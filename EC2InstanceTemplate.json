{
  "Description": "Compute,EC2,v1.0,Create EC2 Instance with Key Pair beta-fdp-1p7mq4srk",
  "Parameters": {
      "ContactEmail": {
          "Default": "email@example.com",
          "Description": "Email of owner",
          "Type": "String"
      },
      "InstanceType": {
          "Description": "EC2 instance type",
          "Type": "String",
          "Default": "t2.micro",
          "AllowedValues": [
              "t2.micro",
              "t2.small",
              "t2.medium",
              "t3.micro",
              "t3.small",
              "t3.medium"
          ]
      },
      "DurationDays": {
          "Default": "0",
          "AllowedValues": [
              "0",
              "2",
              "7",
              "30",
              "60",
              "90"
          ],
          "Description": "Duration Days",
          "Type": "String"
      },
      "DurationHours": {
          "Default": "0",
          "AllowedValues": [
              "0",
              "1",
              "2",
              "3",
              "4",
              "5"
          ],
          "Description": "Duration Hours",
          "Type": "String"
      },
      "DurationMinutes": {
          "Default": "10",
          "AllowedValues": [
              "10",
              "20",
              "30",
              "40",
              "50",
              "60"
          ],
          "Description": "Duration Minutes",
          "Type": "String"
      },
      "AutoTerminate": {
          "Default": "True",
          "AllowedValues": [
              "True",
              "False"
          ],
          "Description": "Should the product Auto Terminate",
          "Type": "String"
      },
      "Action": {
          "Default": "Terminate",
          "AllowedValues": [
              "Terminate",
              "Notify",
              "Other"
          ],
          "Description": "What action should be taken at the end of the service",
          "Type": "String"
      },
      "KeyName": {
          "Description": "The name of an existing EC2 KeyPair, or a new KeyPair will be created if not provided",
          "Type": "String",
          "Default": "",
          "ConstraintDescription": "Must be an alphanumeric string, optionally with hyphens and underscores."
      },
      "InstanceName": {
          "Description": "EC2 instance name",
          "Type": "String",
          "Default": "sc-ec2-instance"
      }
  },
  "Metadata": {
      "AWS::CloudFormation::Interface": {
          "ParameterGroups": [
              {
                  "Label": {
                      "default": "Subscription End Information"
                  },
                  "Parameters": [
                      "AutoTerminate",
                      "DurationDays",
                      "DurationHours",
                      "DurationMinutes",
                      "Action",
                      "ContactEmail"
                  ]
              }
          ]
      }
  },
  "Conditions": {
      "CreateNewKeyPair": {
          "Fn::Equals": [
              {
                  "Ref": "KeyName"
              },
              ""
          ]
      }
  },
  "Resources": {
      "EC2KeyPair": {
          "Type": "AWS::EC2::KeyPair",
          "Condition": "CreateNewKeyPair",
          "Properties": {
              "KeyName": {
                  "Fn::Join": [
                      "-",
                      [
                          {
                              "Ref": "AWS::StackName"
                          },
                          "KeyPair"
                      ]
                  ]
              }
          }
      },
      "MyVPC": {
        "Type": "AWS::EC2::VPC",
        "Properties": {
          "CidrBlock": "10.0.0.0/16",
          "EnableDnsSupport": "true",
          "EnableDnsHostnames": "true",
          "InstanceTenancy": "default",
          "Tags": [
            {
              "Key": "Name",
              "Value": "MyVPC"
            }
          ]
        }
      },

      "ThatEC2Instance": {
          "Type": "AWS::EC2::Instance",
          "DependsOn":[
            "MyVPC",
            "MySubnet",
            "InstanceSecurityGroup"
          ],
          "Properties": {
              "InstanceType": {
                  "Ref": "InstanceType"
              },
              "KeyName": {
                  "Fn::If": [
                      "CreateNewKeyPair",
                      {
                          "Ref": "EC2KeyPair"
                      },
                      {
                          "Ref": "KeyName"
                      }
                  ]
              },
              "ImageId": "ami-0ae8f15ae66fe8cda",
              "SecurityGroupIds": [
                  {
                      "Ref": "InstanceSecurityGroup"
                  }
              ],
              "SubnetId":{
                "Ref":"MySubnet"
              },
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": {
                          "Fn::Join": [
                              "",
                              [
                                  {
                                      "Ref": "InstanceName"
                                  },
                                  "-",
                                  {
                                      "Fn::Select": [
                                          8,
                                          {
                                              "Fn::Split": [
                                                  "-",
                                                  {
                                                      "Ref": "AWS::StackId"
                                                  }
                                              ]
                                          }
                                      ]
                                  }
                              ]
                          ]
                      }
                  }
              ]
          }
      },
      "MySubnet": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "MyVPC"
          },
          "CidrBlock": "10.0.1.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              0,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "MapPublicIpOnLaunch": true,
          "Tags": [
            {
              "Key": "Name",
              "Value": "MySubnet"
            }
          ]
        }
      },
      "InstanceSecurityGroup": {
          "Type": "AWS::EC2::SecurityGroup",
          "Properties": {
              "GroupDescription": "Enable SSH access via port 22",
              "VpcId":{"Ref":"MyVPC"},
              "SecurityGroupIngress": [
                  {
                      "IpProtocol": "tcp",
                      "FromPort": "22",
                      "ToPort": "22",
                      "CidrIp": "0.0.0.0/0"
                  }
              ]
          }
      }
  },
  "Outputs": {
      "Duration": {
          "Description": "AutoTerminate setting",
          "Value": {
              "Fn::Sub": "This action [${Action}] will be taken in ${DurationDays} Days ${DurationHours} Hours ${DurationMinutes} Minutes"
          }
      },
      "InstanceId": {
          "Description": "EC2 Instance ID",
          "Value": {
              "Ref": "ThatEC2Instance"
          }
      },
      "InstancePublicIP": {
          "Description": "The public IP address of the EC2 instance",
          "Value": {
              "Fn::GetAtt": [
                  "ThatEC2Instance",
                  "PublicIp"
              ]
          }
      },
      "EC2ConsoleURL": {
          "Description": "URL to the EC2 instance in the AWS Console",
          "Value": {
              "Fn::Join": [
                  "",
                  [
                      "https://console.aws.amazon.com/ec2/v2/home?region=",
                      {
                          "Ref": "AWS::Region"
                      },
                      "#Instances:search=",
                      {
                          "Ref": "ThatEC2Instance"
                      }
                  ]
              ]
          }
      },
      "KeyNameUsed": {
          "Description": "The name of the KeyPair used for the EC2 instance",
          "Value": {
              "Fn::If": [
                  "CreateNewKeyPair",
                  {
                      "Ref": "EC2KeyPair"
                  },
                  {
                      "Ref": "KeyName"
                  }
              ]
          }
      }
  }
}